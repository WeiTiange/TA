# PBR

```toc
```

## PBR理论

PBR是对真实物理光照的近似，是**基于物理的渲染**而不是**物理的渲染**。
PBR需要满足三个条件才能被称为PBR：
- 基于微表面的表面模型
- 能量守恒
- 使用基于物理的BRDF



## 微表面模型

达到微观尺度之后，任何的平面都可以用被称为**微表面(Microfacets)** 的微小**镜面**来进行描述，而基于**表面**的粗糙度的不同，这些**微表面**的排列也会发生变化。


![[PBR_微表面概念.png]]

当实现**镜面反射**时，入射光线更趋向于在**粗糙表面**上向完全不同的方向**散射**开来，产生分布更广的镜面反射，而在**光滑表面**上，更趋向于向**同一个方向**反射，产生更小更锐利的反射。通过给定的**粗糙度 (0到1)**， 可以模拟表面的粗糙程度。更高的粗糙度会产生更大而模糊的镜面反射区域，而更小的粗糙度会产生更小和锐利的高光区域。

![[PBR_粗糙度.png]]



## 能量守恒

**出射光的能量永远不能超过入射光的能量(自发光表面除外)。**

为了遵循能量守恒，需要对**漫反射**和**镜面反射**做出区分。当一束光碰撞到一个表面时，他会分离成**折射**部分和**反射**部分：
- 折射：**漫反射**。光线进入表面并且被吸收
- 反射：**镜面反射**。光线不进入表面而是直接被反射

光粒子(光线)在进入物体表面之后，会与物体的粒子进行碰撞被吸收能量直至能量耗尽，或者离开表面。漫反射的光线离开表面后将会共同构成表面的**漫反射颜色**。

对于**金属**表面，折射和反射的原理是一样的，但是**所有的**的折射光都会被直接吸收而不会散开。也就是说金属表面**没有**漫反射颜色。

一束光射入一个表面所分离开的折射光和反射光是互斥的，因为无论何种光线，被物体表面反射的光无法再被表面所吸收，所以反射光所剩下的能量就是折射光的能量。

``` glsl
float kS = calculateSpecularComponent();    // 反射/镜面反射
float kD = 1.0 - kS;                        // 折射/漫反射
```

## 反射率方程

PBR所使用的是被称为**反射率方程**的一个[渲染方程](https://en.wikipedia.org/wiki/Rendering_equation)的特化版本。
**$L_{o}$表示了从$\omega_{o}$方向上观察，光线投射到点$p$上反射出来的辐照度(所有光源对点$p$的辐射率的总和)**
$$
L_o(p,\omega_o) = \int\limits_{\Omega} f_r(p,\omega_i,\omega_o) L_i(p,\omega_i) n \cdot \omega_i d\omega_i
$$
- ***一些辐射率相关的物理量***
**辐射通量Φ**：光源发出的光的**颜色**和**强度**
- 表示的是**一个**光源所输出的能量。由于光(日光)包含了所有的可见波长，也就是颜色，所以辐射通量所表示的就是一个光源的发出的光的**颜色**和**强度** ![[PBR_辐射通量.png]]
**立体角ω**：
- 投射到单位球体上的一个截面的大小或者面积
- ![[PBR_立体角.png]]
**辐射强度I**：
- 一个光源想每个单位立体角所投送的辐射通量
- 辐射强度公式：
$$
I = \frac{d\Phi}{d\omega}
$$
通过辐射通量、辐射强度和立体角，可以计算出**辐射率**方程，即一个拥有辐射强度Φ的光源在单位面积A，单位立体角ω上的辐射总能量：
$$L=\frac{d^2\Phi}{ dA d\omega \cos\theta}
$$
辐射率表示的是一个区域平面上光线总量的物理量。他收到光方向和表面法线方向的的余弦值$\cos\theta$ 的影响，也就是`dot(nDir, lDir)`。
把立体角和面积A看做是无穷小的，就可以用辐射率来表示单束光线穿过空间中的一个点的通量，进而可以计算出作用于单个片段上的单束光线的辐射率。
把**立体角**转变为**方向向量**，把**面积A**转换为**点P**，就可以在Shader中使用辐射率计算单束光线对每个片段的作用。
当涉及到辐射率时，我们通常关心的是**所有**投射到点p上的光线的**总和**，而这个和就称为辐射照度或者**辐照度(Irradiance)**。

那么在反射率方程中：
$$
L_o(p,\omega_o) = \int\limits_{\Omega} f_r(p,\omega_i,\omega_o) L_i(p,\omega_i) n \cdot \omega_i d\omega_i
$$
**反射率公式计算出了点$p$在$w_o$方向上被反射出来的辐射率$L_{o}(p, w_{o})$的总和。
或者说$L_{o}$表示了从$w_{o}$方向上观察，光线投射到点$p$上反射出来的辐照度(所有光线反射量的总和)。**
**反射率方程概括了在半球领域$\Omega$内，碰撞到了点pp上的所有入射方向$w_i$ 上的光线的辐射率，并受到$f_{r}$的约束，然后返回观察方向上反射光的$L_{o}$。**



## BRDF

BRDF是反射率函数中的$f_r$，**双向反射分布函数(Bidirectional Reflective Distribution)**。用于基于表面材质属性来对入射辐射率进行缩放或加权。

BRDF接受**四个**参数作为函数的输入参数：
- 入射方向$w_i$，即光方向
- 出射方向$w_o$，即观察方向
- 平面的法线方向$n$
- 粗糙度$a$

BRDF可以求出美术光线对于平面上最终反射出来的出射光线所做出的**贡献程度**，也就是每束入射光线基于粗糙度在出射光线中的占比。
如果一个平面是完全光滑的，即粗糙度为0，那么只有与出射光线拥有相同反射角度的光线会得到1.0的返回值，其他所有光线都会返回0。

几乎所有的实时渲染管线使用的都是**Cook-Torrance BRDF模型**。Cook-Torrance BRDF有漫反射和镜面反射两个部分：
$$f_r = k_d f_{lambert} +  k_s f_{cook-torrance}$$
- $k_{d}$是**被折射部分(漫反射)** 的能量所占的比率
- $k_{s}$是**被反射部分(镜面反射)** 的能量所占的比率

$f_{lambert}$表示了**漫反射**部分，被称为**Lambertian漫反射**，公式为
$$f_{lambert} = \frac{c}{\pi}$$
其中$c$是物体的表面颜色(颜色纹理)，除以$\pi$是为了对漫反射光进行标准化，因为前面还有BRDF的积分方程是受$\pi$影响的。
Lambertian漫反射依旧使用`dot(nDir, Ldir)`，只是他并不在BRDF内部，而是反射率公式的末尾的$n \cdot \omega_{i}$ 

$f_{cook-torrance}$表示了**镜面反射**部分，公式为
$$f_{cook-torrance} = \frac{DFG}{4(\omega_o \cdot n)(\omega_i \cdot n)}$$
Cook-Torrance BRDF的镜面反射部分包含三个函数，他的分母部分还有一个标准化因子。字幕D，F和G分别代表着一种类型的函数，每个函数分别用来近似的计算出表面反射特性的一个特定的部分。三个函数分别为：
- $D$ - **法线分布函数(Normal Distribution Function)** ：基于**粗糙度**对于表面的影响，近似的计算出与半程向量***h***对齐的**微表面**的**数量**
- $G$ - **几何函数(Geometry Function)** ：描述了微表面的自我遮挡的属性。当一个表面的微表面比较粗糙时，表面上的微表面有可能会挡住其他的微表面从而减少表面所反射的光线
- $F$ - **菲涅尔方程(Fresnel Equation)** ：描述在不同的表面角下，表面所反射的光线所占的比例
- *每个函数都有很多不同的形式，有的真实，有的性能高效。*
- *这里的D使用Trowbridge-Reitz GGX，F使用Fresnel-Schlick, G使用Smith’s Schlick-GGX*

## 法线分布函数(Trowbridge-Reitz GGX)

法线分布函数D，又叫镜面分布，从统计学上近似的表示了法线方向与半程向量***h***一致的微表面的比例。假设有一个半程向量$h$，如果表面中有45%的微表面的法线方向与$h$一致，那么NDF就会返回0.35。Trowbridge-Reitz GGX的公式：
$$NDF_{GGX TR}(n, h, \alpha) = \frac{\alpha^2}{\pi((n \cdot h)^2 (\alpha^2 - 1) + 1)^2}$$
- $n$：法线方向
- $h$：半程向量
- $a$：表面粗糙度

不同粗糙度下的效果：![[PBR_粗糙度.png]]
当**粗糙度很低**时，物体的表面**法线方向更有规律**，具有相同法线方向的微表面更加集中，从而导致与半程向量$h$方向一致的微表面数量减少并且集中，进而产生更加小而锐利的高光点。
而当**粗糙度较高**时，物体的表面**法线方向更加的随机**，具有相同法线方向的微表面分布的更广，更加的**不集中**，从而导致与半程向量$h$方向一致的微表面数量增加并且范围更大，进而产生更加大的高光范围。

**TR GGX在GLSL中的代码**
``` 
float D_GGX_TR(vec3 nDir, vec3 hDir, float a) {
	float a2     = a * a;
	float NdotH  = max(dot(nDir, hDir), 0.0);
	float NdotH2 = NdotH * NdotH;

	float nom    = a2;
	float denom  = (NdotH2 * (a2 - 1.0) + 1.0);
	denom        = PI * denom * denom;

	return nom / denom;
}
```



## 几何函数(Schlick-GGX)

几何函数近似的求得了微表面之间互相遮蔽的比例，互相遮蔽会损耗光线的能量。![[PRB_微表面互相遮蔽.png]]

 几何函数也采用了表面的**粗糙度**作为其中一个输入参数，粗糙度较高的表面的微表面间相互遮蔽的概率会更高。 Schlick-GGX的几何函数公式：
$$G_{SchlickGGX}(n, v, k) = \frac{n \cdot v}{(n \cdot v)(1 - k) + k }$$
由于微表面之间的对于光线的遮挡与否与**光方向**和**视方向**都有关 (上面图中的两种遮挡情况)，所以需要在计算中考虑到两者。完整的SmithSchlickGGX公式：
$$G(n, v, l, k) = G_{sub}(n, v, k) G_{sub}(n, l, k)$$
- $n$：法线方向
- $v$：观察方向
- $l$：光方向
- $k$：基于使用的是直接光照还是IBL光照而对粗糙度$a$的重映射
	- 直接光照：$k_{direct} = \frac{(\alpha + 1)^2}{8}$
	- IBL光照：$k_{IBL} = \frac{\alpha^2}{2}$

得到的效果：![[PBR_几何函数效果.png]]
几何函数的范围是\[0, 1]。1代表了没有微表面阴影，而0代表了该微表面被彻底遮蔽

**Smith-Schlick-GGX在GLSL中的代码**
```
float GeometrySchlickGGX(float NdotV, float k) {
	float nom   = NdotV;
	float denom = NdotV * (1.0 - k) + k;

	return nom / denom;
}

float GeometrySmith(vec3 nDir, vec3 vDir, vec3 lDir, float k) {
	float NdotV = max(dot(nDir, vDir), 0.0);
	float NdotL = max(dot(ndir, lDir), 0.0);
	float ggx1  = GeometrySchlickGGX(NdotV, k);
	float ggx2  = GeometrySchlickGGX(NdotL, k);

	return ggx1 * ggx2;
}
```



## 菲涅尔方程(Fresnel-Schlick Approximation)

菲涅尔方程描述的是**被反射**光线占**被折射**光线的比例，这个比例会根据观察方向与微表面法线方向的夹角的变化而变化。
当光线碰撞到一个表面的时候，菲涅尔方程会根据观察方向和法线方向告诉我们**被反射的光线(镜面反射)所占的百分比**。利用这个反射比率和能量守恒原则，我们可以直接得出光线**被折射的部分以及光线剩余的能量**。
当观察方向与物体表面的法线方向相同时，物体的表面只具有最基本的反射性，而当从接近90°的角度观察物体表面时，物体的反光会非常明显。理论上在90°角观察时，所有的平面都能完全的反射光线。

菲涅尔方程的公式：
$$F_{Schlick}(h, v, F_0) = F_0 + (1 - F_0) ( 1 - (h \cdot v))^5$$
- $F_0$：表面的基础反射率，是通过**折射指数(IOR, Indice of Refraction)** 计算出来的
	- 金属表面的$F_0$一般都是有颜色的，而且只有金属的$F_0$有颜色

由于要考虑到金属与非金属的区分，需要添加一个**金属度**的参数。金属度用来描述一个材质表面时金属的还是非金属的。
*理论上，一个物体只能是金属或者非金属，没有中间值。但是由于材质纹理精度不足以描述一个拥有如细沙/沙状粒子/刮痕的金属表面，调整这些表面的金属度到一个中间值可以获得很好的效果*

由于对于金属表面的物体，使用他们的折射指数计算折射率并不能得出正确的结果，所以需要先预计算$F_0$的值。由于金属没有漫反射，所以可以直接使用Albedo纹理给的颜色值作为金属的基础反射率。

使用线性插值，根据金属度，对金属与非金属使用不同的$F_0$：
```
vec3 F0 = vec3(0.04);
F0      = mix(F0, Albedo.rgb, metalness);
```

**菲涅尔在GLSL中的代码**
```
vec3 fresnelSchlick(float NdotV, vec3 F0) {
	return F0 + (1 - F0) * pow(1 - NdotV, 5.0);
}
```




## 完全展开的Cook-Torrance反射率方程

$$L_o(p,\omega_o) = \int\limits_{\Omega} (k_d\frac{c}{\pi} + k_s\frac{DFG}{4(\omega_o \cdot n)(\omega_i \cdot n)})L_i(p,\omega_i) n \cdot \omega_i  d\omega_i$$
**用人话写出来是：**
$$
输出颜色 = \int\limits_{\Omega}(漫反射比例 \frac{纹理原色}{\pi} + 镜面反射比例 \frac{镜面高光·几何遮蔽·菲涅尔效应}{4(vDir·nDir)(lDir·nDir)})光源颜色(lDir·nDir)dw_{i}
$$
**如果只考虑单个不衰减的直线光照(Directional Light)的话，可以将积分的部分去掉：**

***关于BRDF中漫反射部分为什么要除以π：***
因为 $\int_{2\pi}\cos\theta_{o}dw_{o}=\pi$ ，如果散射的光线最后都能汇集到一点的话，积分的结果就是会再乘一个π。所以分散的时候就需要除π。

## PBR Albedo工作流

![[PBR_Albedo工作流.png]]
**Albedo** ：同时包含了**金属的**反射颜色，以及**非金属的**漫反射颜色
**Normal**：法线贴图
**Metallic**：金属度，范围在\[0, 1]，0为非金属，1为金属
**Roughness**：粗糙度，范围在\[0, 1]，0为完全不粗糙，1为非常粗糙
**AO**：AO

Roughness可以在暴露至面板的参数中改成**光滑度**，0为非常粗糙，1为非常光滑，只要在Shader里一减一下光滑度的值作为粗糙度进行后续的计算就行。



## PBR的光照实现-直接光照明

***PBR所需的相关数据：***
- Albedo(RGB，直给参数/纹理贴图)
- Metallic(Grayscale，直给参数/纹理贴图)
- Roughness(Grayscale，直给参数/纹理贴图)
- AO(Grayscale，直给参数/纹理贴图)
- Normal Map(RGB，纹理贴图)
- 世界空间法线方向
- 世界空间片段位置
- 世界空间视方向
- 世界空间光方向
- UV(如果有贴图需要采)

PBR的计算需要循环遍历**每个光源**，计算他们**独立的**辐射率然后**求和**。然后根据BRDF和光源的入射角缩放该辐射率。可以把对每个光源的循环当做在物体的半球领域对所有直接光源求积分。

在Unity里计算多个点光源并求和时，需要将点光源的计算放在第二Pass里，并开启混合(Blend One One)。第一个Pass将计算平行光的光照信息，第一个Pass需要添加`#pragma multi_compile_fwdbase`并将Pass的Tags设置为`"LightMode"="ForwardBase"`。而在第二个Pass中将计算(默认)前4个`important`的光源。每个光源会执行一次Pass，并将结果与上一次的结果混合。第二个Pass需要添加`#pragma multi_compile_fwdadd`，并将Pass的Tags设置为`"LightMode"="ForwardAdd"`。
*环境光的计算要在计算平行光时添加，而不在点光源Pass中添加*



## IBL(Image Based Lighting)

IBL使用Cubemap，将Cubemap的每个像素视为光源。

将反射方程的**漫反射**和**镜面反射**部分拆开可以得到：
- 漫反射部分：
$$L_o(p,\omega_o) = 
        \int\limits_{\Omega} (k_d\frac{c}{\pi}) L_i(p,\omega_i) n \cdot \omega_i  d\omega_i
$$
- 镜面反射部分：
$$\int\limits_{\Omega} (k_s\frac{DFG}{4(\omega_o \cdot n)(\omega_i \cdot n)}) L_i(p,\omega_i) n \cdot \omega_i d\omega_i$$

***IBL的漫反射部分***
$$L_o(p,\omega_o) = 
        \int\limits_{\Omega} (k_d\frac{c}{\pi}) L_i(p,\omega_i) n \cdot \omega_i  d\omega_i$$
在反射方程的漫反射部分中，兰伯特项是个常数(颜色$c$, $k_{d}$ ,以及$\pi$ 都是常数)，所以可以将其移出积分：
$$L_o(p,\omega_o) = 
        k_d\frac{c}{\pi} \int\limits_{\Omega} L_i(p,\omega_i) n \cdot \omega_i  d\omega_i$$

***关于引擎中的反射探针***
在计算IBL光照的时候会假设被照点$p$位于IBL贴图的中心，这样可能会破坏真实感(尤其是在室内)。在游戏引擎中可以放置**反射探针**来解决这个问题。每个反射探针会单独的预计算其周围环境的辐照度图，而位置$p$ 的辐照度则会取离他最近的反射探针的辐照度内插值。


## 单词表

- 辐射通量(Radiant Flux)：**一个**光源所发出的光的**颜色**和**强度**
- 辐射率(Radiance)：**一个**光源所能到达一个面的能量总量
- 辐照度(Irradiance)：一个面上**所有**光线能量的总和
- 辐射强度(Radiant Intensity)：**一个**光源对一个面所投射的辐射通量(光线强度、颜色)
- 半球领域：一个片段的辐照度由在以该片段法线方向为轴的一个半球范围内的所有光源决定
