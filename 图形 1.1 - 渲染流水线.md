# 渲染流水线
#渲染 #顶点着色器 #片元着色器 #光栅化 #抗锯齿 #曲面细分 #Unity

## 整体流程

- 应用阶段
	- 粗粒度剔除
	- 进行渲染设置
	- 准备场景基本数据
		- 场景里物体的位置，大小，朝向
		- 物体的每一个顶点的位置，法线，切线
		- 场景光源的位置，朝向，属性
		- 摄像机的位置，朝向，属性
		- 。。。
	- 输出到几何阶段

- 几何阶段
	- 顶点着色器
		- 顶点光照
			- 光源位置和朝向
			- 摄像机的位置和朝向
			- 当前顶点的世界位置
			- 顶点在模型空间的位置
			- 模型本身的位置，旋转，缩放
	- 曲面细分
		- 通过现有的顶点生成更多的顶点
	- 几何着色器
		- 通过现有图元生成更多的顶点和图元
			- 对现有图元所在的平面生成法线
	- 顶点剪裁
		- 剪裁掉屏幕以外看不到的顶点
	- 屏幕映射
		- 把顶点位置从3D坐标空间转换到2D坐标空间

- 光栅化阶段
	- 三角形设置
		- 拿到映射到2D空间的顶点位置，把他们组装成三角形
	- 三角形遍历
		- 知道三角形包含了哪些2D空间中的像素点
	- 片段着色器
		- 对点使用他们所包含的数据来进行着色
		- 为后面的逐片元着色准备数据

- 逐片元操作
	- 裁剪测试
	- 透明度测试
	- 深度测试
	- 模板测试
	- 混合

- 后处理
	- 模糊
	- 景深
	- 高光
	- ...


## 应用阶段 - CPU

- 准备基本场景数据
	- 场景物体数据
		- 物体变换数据：位置、旋转、缩放等
		- 物体网格数据：顶点位置、UV贴图等
	- 摄像机数据
		- 位置、方向、远近剪裁平面
		- 正交、透视 (FOV)
		- 视口比例/尺寸等
	- 光源及阴影数据
		- 光源
			- 方向光：颜色、方向等
			- 点光源：颜色、位置、范围、衰减系数等
			- 聚广源：颜色、位置、方向、内外圆锥角等
		- 阴影
			- 是否需要阴影：判断该光源可见范围内是否有可投射阴影的物体
			- 阴影参数：对应光源序号、阴影强度、级联参数、深度偏移、近平面偏移等
		- 逐光源绘制阴影贴图
			- 近平面偏移
			- 逐级联
				- 计算当前光源+级联对应的观察矩阵、投影矩阵、以及对应到阴影贴图里的视口区域
			- 绘制到阴影贴图
	- 其他全局数据

- 加速算法，粗粒度剔除
	- 碰撞检测
	- 加速算法 (?)
	- 遮挡剔除
		- 可见光裁剪
		- 可见场景物体裁剪
			- 八叉树
			- BSP树
			- K-D树
			- BVH包围盒
	- 其他算法

- 设置渲染状态，准备渲染参数
	- 绘制设置
		- 使用着色器
		- 合批方式
	- 绘制顺序 (可以有多种方式)
		- 相对摄像机的距离
		- 才是RenderQueue
		- UICanvas
		- 其他方式等
	- 渲染目标
		- FrameBuffer
		- RenderTexture
	- 渲染模式
		- 前向渲染
		- 延迟渲染

- 调用DrawCall，输出渲染图元到显存
	- 顶点数据
		- 位置
		- 颜色
		- 法线
		- 纹理UV坐标
		- 其他顶点数据
	- 其他数据
		- MVP变换矩阵
		- 纹理贴图
		- 其他数据

## 几何阶段

- 顶点着色 Vertex Shading
	- 视图变换
		- ![[Drawing 2022-05-17 12.32.20.excalidraw]]
	- 顶点着色

- 可选顶点处理
	- 曲面细分(可选)
		- 使用顶点着色器输出的顶点，按照一定的规则和算法，生成更多的顶点(细分)
	- 几何着色器(可选)
		- 通过给定的图元来生成更多的图元
		- ![[Pasted image 20220517124258.png]]
	- 对GPU有一定要求

- 投影 Projection
	- 3D转2D
	- 正交
	- 透视
	- GPU自动完成
	- *至此完成了从顶点空间到投影空间的过程*

- 裁剪 Clipping
	- 在标准设备坐标系中进行
		- OpenGL：x,y,z 都是 (-1, 1) 的范围
		- D3D： x,y 的范围是 (-1, 1), z 的范围是 (0, 1)
	- 剔除视野外的顶点
	- 如果一个图元的一部分被剔除，还会生成两个新的顶点来补全这个图元
	- 视锥体裁剪 CVV
		- 剔除不在视锥体内的顶点
	- 正面或背面剔除(可配置)
		- 可以在shader中通过代码控制开关

- 屏幕映射 Screen Mapping
	- **得到每一个顶点在屏幕坐标下的位置**
	- 从连续到离散
		- 从3D空间中连续的顶点(连续) 变成 屏幕空间中一个个独立的像素点(离散)
	- 范围是屏幕显示尺寸 (1920 * 1080)
	- 坐标系差异(OpenGL/D3D)
		- OpenGL：原点在左下方
		- D3D：原点在左上方

## 光栅化阶段

- 三角形设置 Triangle Setup
	- 计算图元所覆盖的像素范围的边界信息

- 三角形遍历 Triangle Traversal
	- 寻找被三角形网格所覆盖的所有像素
	- 得到所有被三角形覆盖的像素之后，会用三角形的三个顶点，对每一个像素进行线性插值，得到三角形所覆盖的片元的属性
	- **得到的片元并不等同于该三角形所覆盖的像素的最终属性，同一个像素可能覆盖了很多个片元重叠在一起，需要在各自着色以后决定是否保留，保留哪一些，如何混合**
- 抗锯齿(MSAA)
	- SSAA
		- 渲染到一个分辨率放大到n倍的buffer
		- 对放大n倍的buffer采样
	- MSAA
		- 在光栅化阶段计算多个覆盖样本
	- FXAA/TXAA
		- 后处理

## 逐片元操作

- 片元着色 Fragment Shader (可编程)
	- 通过对三角形的三个顶点进行线性插值来得到三角形所覆盖的每一个像素的值

- 颜色混合 Color Blending (可配置)
	- Alpha Test
		- 透明度小于给定阈值的片元就会被舍弃
	- Depth Buffer Test
		- 将当前片元的深度值和深度缓冲中的深度值进行比较，通过比较的就保留下来，没通过的就舍弃掉
	- Stencil Test
	- Blending
		- 

- 目标缓冲区
	- FrameBuffer
	- RenderTexture

- 流水线，各测试先后顺序：
	- [深度测试/模版测试/透明度测试先后顺序是什么样的? By 王永宝](https://www.zhihu.com/question/384124671/answer/1120478668)
	- [深度测试/模版测试/透明度测试先后顺序是什么样的? By 林红旭Leo](https://www.zhihu.com/question/384124671/answer/1121443495)
	- [渲染管线 From Bob Blog](https://chenanbao.github.io/2019/01/19/%E6%B8%B2%E6%9F%93%E7%AE%A1%E7%BA%BF/)